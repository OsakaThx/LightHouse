<%- include('../../partials/admin/header', { title: page ? 'Editar Página' : 'Agregar Página' }) %>

<div class="bg-white shadow rounded-lg p-6">
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-sky-900"><%= page ? 'Editar Página' : 'Agregar Nueva Página' %></h2>
    <p class="text-gray-600"><%= page ? 'Actualiza la información de la página' : 'Completa el formulario para agregar una nueva página' %></p>
  </div>

  <form action="/admin/pages/save" method="POST" class="space-y-6">
    <% if (page) { %>
      <input type="hidden" name="id" value="<%= page.id %>">
    <% } %>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="space-y-6">
        <div>
          <label for="title" class="block text-sm font-medium text-sky-900">Título *</label>
          <input type="text" id="title" name="title" required value="<%= page ? page.title : '' %>"
            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
        </div>
        <div>
          <label for="slug" class="block text-sm font-medium text-sky-900">Slug *</label>
          <input type="text" id="slug" name="slug" required placeholder="ej: sobre-nosotros" value="<%= page ? page.slug : '' %>"
            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
          <p class="text-xs text-gray-500 mt-1">Se usa en la URL: /<span id="slugPreview"><%= page ? page.slug : '' %></span></p>
        </div>
        <div>
          <label for="status" class="block text-sm font-medium text-sky-900">Estado</label>
          <select id="status" name="status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
            <option value="draft" <%= page && page.status === 'draft' ? 'selected' : '' %>>Borrador</option>
            <option value="published" <%= page && page.status === 'published' ? 'selected' : '' %>>Publicado</option>
          </select>
        </div>
        <div>
          <label for="sort_order" class="block text-sm font-medium text-sky-900">Orden</label>
          <input type="number" id="sort_order" name="sort_order" min="0" value="<%= page ? (page.sort_order || 0) : 0 %>"
            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
        </div>
      </div>
      <div class="space-y-6">
        <div>
          <label for="hero_image_url" class="block text-sm font-medium text-sky-900">Imagen principal (hero)</label>
          <select id="hero_image_url" name="hero_image_url" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
            <option value="">Sin imagen</option>
            <% heroImages.forEach(img => { %>
              <option value="<%= img.url %>" <%= page && page.hero_image_url === img.url ? 'selected' : '' %>><%= img.name %></option>
            <% }) %>
          </select>
          <div class="mt-2">
            <% if (page && page.hero_image_url) { %>
              <img src="<%= page.hero_image_url %>" alt="Hero" class="h-32 rounded object-cover">
            <% } %>
          </div>
        </div>
        <div>
          <label for="content" class="block text-sm font-medium text-sky-900">Contenido</label>
          <input type="hidden" id="content" name="content" value="<%- page ? (page.content || '') : '' %>">
          <div id="editor" class="bg-white border border-gray-300 rounded-md">
            <%- page ? (page.content || '') : '' %>
          </div>
          <p class="text-xs text-gray-500 mt-1">Usa el editor para formatear el contenido de la página.</p>
        </div>
      </div>
    </div>

    <div class="flex justify-end space-x-3">
      <a href="/admin/pages" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">Cancelar</a>
      <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-sky-700 hover:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500"><%= page ? 'Actualizar Página' : 'Guardar Página' %></button>
    </div>
  </form>
</div>

<!-- Quill WYSIWYG (CDN) -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
  // auto slug
  const titleInput = document.getElementById('title');
  const slugInput = document.getElementById('slug');
  const slugPreview = document.getElementById('slugPreview');
  if (titleInput && slugInput) {
    titleInput.addEventListener('input', () => {
      const v = titleInput.value.toLowerCase().trim()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
      slugInput.value = v;
      slugPreview.textContent = v;
    });
  }

  // Initialize Quill editor
  const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Escribe el contenido de la página...',
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        ['link', 'blockquote', 'code-block'],
        [{ align: [] }],
        ['clean']
      ]
    }
  });

  // Sync content on form submit
  const form = document.querySelector('form[action="/admin/pages/save"]');
  form.addEventListener('submit', function() {
    const html = document.querySelector('#editor .ql-editor').innerHTML;
    document.getElementById('content').value = html;
  });
</script>

<%- include('../../partials/admin/footer') %>
